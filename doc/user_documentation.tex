\documentclass{article}[a4paper]
\usepackage{tcolorbox}
\usepackage[pdfborder={0 0 0}]{hyperref}
\usepackage{tabularx}
\usepackage{enumitem}

\makeatletter
\newcommand\subsubsubsection{\@startsection{paragraph}{4}{\z@}%
            {-2.5ex\@plus -1ex \@minus -.25ex}%
            {1.25ex \@plus .25ex}%
            {\normalfont\normalsize\bfseries}}
\makeatother
\setcounter{secnumdepth}{4}
\setcounter{tocdepth}{4}

\title{SWT21 lab kit \\ User manual}
\author{Bin√§s Teknik AB}

\begin{document}
\maketitle
\tableofcontents
\newpage

\section{General}

The SWT21 lab kit allows communication and measurements using a single
microcontroller with a carrier board. The lab kit runs a firmware allowing a
computer to be connected as host which can then control the lab kit using the
host interface. This allows us to inspect network communication, interact with
hardware, etc. from the host computer.

The general connectivity of the lab kit is

\medskip
\renewcommand{\arraystretch}{1.5}
\noindent
\begin{tabularx}{\textwidth}{|p{2cm}|p{1.5cm}|X|}
\hline
test & test & Comment \\
\hline
WiFi \hbox{802.11 b/g/n} 2.4 GHz &  & AP mode and STA mode \\
\hline
Bluetooth 4.2 & &  Classic \& Low energy mode \\
\hline
CAN 2.0 & 1x & Only standard ID:s, 120 $\Omega$ termination available via jumper
 configuration \\
\hline
LIN 2.2 & 1x & Master or slave via jumper configuration \\
\hline
UART & 1x & 3.3V maximum 2 Mbit/s, configurable 1-2 stop bits and parity bit \\
\hline
ADC & 2x & 0-3 V or 0-30 V via jumper configuration \\
\hline
DAC & 2x & 0-3 V or 0-12 V via jumper configuration (0-12 V) requires external power supply)\\
\hline
\end{tabularx}


\subsection{Syntax rules}
This manual uses the following syntax for describing commands

\medskip
\noindent
\begin{tabularx}{\textwidth}{|p{4cm}|X|}
\hline
<text> & indicates option to be replaced by other text \\
\hline
[text] & optional argument to be replaced by other text if used\\
\hline
[text]... or <text>... & indicates multiple arguments may be used \\
\hline
\{a|b\} & means either a or b may be used \\
\hline
\end{tabularx}


\section{Host interface}
%configuration
%what is unsolicited commands
%syntax

The device is connected to a computer via USB. This connection provides a
USB-UART interface which presents itself as a serial port on the computer,
(COM3, /dev/ttyUSBx, or similar).

The HCI on the lab kit is preconfigured to

\medskip
\noindent
\begin{tabularx}{\textwidth}{|p{3cm}|X|}
\hline
Baudrate: & 2 Mbit/s \\
\hline
Stopbits: & 1 \\
\hline
Parity: & None \\
\hline
\end{tabularx}

\subsection{System requirements}

The lab kit requires a computer with an USB port and is compatible with Windows,
MacOS and Linux.

Drivers for the USB-UART bridge are available from
\url{https://www.silabs.com/developers/usb-to-uart-bridge-vcp-drivers}

\subsection{Protocol}

The communication interface uses text-based communication where each line is a
command or a response. Each line may be up to 255 bytes and ends with a new
line control character
(\textbackslash n). Other control characters will be ignored. The format of
the commands is as follows:
\begin{verbatim}
<module> <command> [arguments]...
e.g.: CAN config filter1 1f0 f70
\end{verbatim}

Responses can either be acknowledged with an
\begin{verbatim}
OK [data]
\end{verbatim}
, where data is any optional data returned by the command, or an error:
\begin{verbatim}
ERR <reason>
\end{verbatim}

General errors:
\begin{itemize}[noitemsep]
\item ERR Invalid command
\item ERR Invalid arguments
\item ERR Command too long
\end{itemize}

Unsolicited commands are events sent from the lab kit to the host without a
preceding command asking directly for it. It is used for events like incoming
communication packets and periodic measurment data. The syntax is the same as
for commands but no response is expected.

\subsubsection{Boot}
On boot an informational string will be written on the host interface with
the following syntax

\begin{verbatim}
SWT21 lab kit
Booting...
Firmware version: <fw version>
Boot reason: <reason>
\end{verbatim}

<reason> may be due to several reasons:
\begin{itemize}[noitemsep]
\item Power on
\item SW reset
\item WDT reset
\item Brownout
\item OS panic
\item Unknown
\end{itemize}

\section{Firmware update}
To update the firmware download and install the official flash download tool from
\url{https://www.espressif.com/en/support/download/other-tools}

Steps:
\begin{enumerate}
\item
\item
\end{enumerate}

\section{CAN}
The CAN bus can be used to send and recive 11-bit ID CAN frames.
When sending frames they can either be sent as single frames or as periodic
frames. Single frames are enqueued on the transmit buffer immediately after a
"CAN send" command has been sent. Periodic frames stores the frame data and
configuration in one
of eight periodic frame buffers. When enabled the periodic frame buffers will
send its payload periodically according to its configuration.


\subsection{CAN commands}
\subsubsection{CAN help}
\begin{tcolorbox}
	{\bf Syntax}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	CAN help

	\medskip
	{\bf Description}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	This command prints out a summary of the CAN commands.

	\medskip
	{\bf Return values}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	OK \\
	<help text>
\end{tcolorbox}

\subsubsection{CAN rx}
\begin{tcolorbox}
	{\bf Syntax}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	CAN rx \{on|off\}

	\medskip
	{\bf Description}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	This command enables or disables receiving CAN frames. When off no unsolicited
	CAN frame commands will be sent. \\
	Default state is off.

	\medskip
	{\bf Return values}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	OK
\end{tcolorbox}

\subsubsection{CAN send}
\begin{tcolorbox}
	{\bf Syntax}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	CAN send <can\_id>\#\{R|data\}

	\medskip
	{\bf Description}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	This command sends a single CAN frame on the CAN bus. On insufficient CAN
	memory it will return an overflow error.
	\medskip \\
	{\it can\_id} - the CAN ID in hexadecimal \\
	{\it R} - represents a remote frame \\
	{\it data} - is the frame data in hexadecimal \\
	\medskip \\
	Example: \texttt{can send 13f\#02e8}

	\medskip
	{\bf Return values}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	OK \\
	ERR Invalid argument \\
	ERR Overflow
\end{tcolorbox}

\subsubsection{CAN config}
\begin{tcolorbox}
	{\bf Syntax}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	CAN config <config key> [<arg>]

	\medskip
	{\bf Description}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	This command sets the configuration values of the CAN subsystem.
	Leaving out an argument returns the current value(s) with the same argument
	format.

	\medskip
	{\bf Return values}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	OK \\
	OK <value>... \\
	ERR Invalid argument
\end{tcolorbox}

\subsubsubsection{CAN config brp}
\begin{tcolorbox}
	{\bf Config key}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	baudrate

	\medskip
	{\bf Arguments}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	<brp> - CAN clock baudrate prescaler

	\medskip
	{\bf Description}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	This configuration sets the CAN baudrate prescaler. The final baudrate can
	be calculated from \vspace{2mm} \\
	\fbox{$\textrm{CAN bitrate} = \frac{80 000 000}{brp * (1 + tseg\_1 + tseg\_2)}$}
\end{tcolorbox}

\subsubsubsection{CAN config tseg\_1}
\begin{tcolorbox}
	{\bf Config key}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	tseg\_1

	\medskip
	{\bf Arguments}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	<tseg\_1> - CAN time segment 1

	\medskip
	{\bf Description}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	This configuration sets the number of time quantas for CAN tseg\_1. The final baudrate can
	be calculated from \vspace{2mm} \\
	\fbox{$\textrm{CAN bitrate} = \frac{80 000 000}{brp * (1 + tseg\_1 + tseg\_2)}$}
\end{tcolorbox}

\subsubsubsection{CAN config tseg\_2}
\begin{tcolorbox}
	{\bf Config key}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	tseg\_2

	\medskip
	{\bf Arguments}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	<tseg\_2> - CAN time segment 2

	\medskip
	{\bf Description}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	This configuration sets the number of time quantas for CAN tseg\_2. The final baudrate can
	be calculated from \vspace{2mm} \\
	\fbox{$\textrm{CAN bitrate} = \frac{80 000 000}{brp * (1 + tseg\_1 + tseg\_2)}$}
\end{tcolorbox}

\subsubsubsection{CAN config sjw}
\begin{tcolorbox}
	{\bf Config key}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	sjw

	\medskip
	{\bf Arguments}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	<sjw> - CAN synchronization jump width

	\medskip
	{\bf Description}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	This configuration sets the CAN synchronization jump width. This is the
	maximum number of time quantas that the synchronization may be synchronized.
\end{tcolorbox}

\subsection{Unsolicited CAN commands}

\subsubsection{CAN RX}
\begin{tcolorbox}
	{\bf Syntax}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	CAN RX: <can\_id>\#\{R|data\}

	\medskip
	{\bf Description}

	\parshape 1 1cm \dimexpr\linewidth-2cm\relax
	This command is sent when the system receives a CAN frame including its data
	\medskip \\
	{\it can\_id} - the CAN ID in hexadecimal \\
	{\it R} - represents a remote frame \\
	{\it data} - is the frame data in hexadecimal

	\medskip
	Example: \texttt{CAN RX: 74e\#8e98}
\end{tcolorbox}



\begin{comment}

\section{LIN}
LIN commands
------------
LIN send <id>
LIN set txbuffer <n> <data>     - empty <data> disables TX buffer

Unsolicited commands:
LIN frame
error?

\end{comment}

\section{Command overview}
\begin{verbatim}
All command and responses are '\n'-terminated.
<module> <command> [arguments]...
Max length: 255 bytes

Common commands:
config <parameter> <value>... - set value(s)
config <parameter>            - get value(s)

Responses
---------
OK [data]
ERR <reason>

ERR Invalid command

CAN commands
------------
CAN status
    - OK CAN status: <rx on> <err frame count>

CAN rx {on|off}
CAN send <can_id>#{R|data}

CAN config parameters
---------------------
baudrate - (integer) baudrate
filter0 - (32-bit hex) filter, (32-bit hex) mask
filter1 - (32-bit hex) filter, (32-bit hex) mask

Unsolicited CAN commands
------------------------
CAN frame <can_id>#{R|data}
CAN errframe <flag>
\end{verbatim}

\begin{comment}
ADC commands
------------
ADC<n> off
ADC<n> single
ADC<n> periodic <period (us)> [offset (us)]
ADC<n> status
    - OK ADC<n> status: <off/single/periodic <period> <offset>>

ADC<n> config raw
ADC<n> config raw              - OK ADC<n> raw: [on/off]
ADC<n> config range <low> <high>
ADC<n> config range            - OK ADC<n> range: <low> <high>
ADC<n> config timestamp <off/on>

Unsolicited ADC commands
------------------------
ADC<n> value [timestamp] <value>

DAC commands
------------
DAC<n> voltage
DAC<n> raw
DAC<n> config range <low> <high>
DAC<n> config range <low> <high>
pwm?

UART commands
-------------
UART<n> send <length>
UART<n>
UART<n> config baudrate <baudrate>
UART<n> config baudrate
UART<n> config format <format>     - e.g. 8n1
UART<n> config format

UART config parameters
----------------------
baudrate - <baudrate int32>
format - <format string> <bits><n|o|p><1|2>
    e.g. 8n1 for 8 bits, no parity and 1 stop bit

Unsolicited UART commands
-------------------------
UART<n> overrun error <n>
UART<n> underrun error <n>
UART<n> framing error <n>
UART<n> parity error <n>
\end{comment}


\end{document}
